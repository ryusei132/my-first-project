<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TODO</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #1a1a2e;
      --surface: #16213e;
      --card: #0f3460;
      --accent: #e94560;
      --accent2: #533483;
      --text: #eaeaea;
      --text-muted: #8a8fa8;
      --border: #1e2a4a;
      --check: #4ecca3;
      --done-text: #5a6070;
      --shadow: 0 8px 32px rgba(0,0,0,0.4);
      --radius: 12px;
      --trans: 0.2s ease;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 48px 16px 80px;
    }

    /* --- Header --- */
    header {
      text-align: center;
      margin-bottom: 36px;
    }
    header h1 {
      font-size: 2.8rem;
      font-weight: 800;
      letter-spacing: 0.12em;
      background: linear-gradient(135deg, var(--accent), #ff9a3c);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    header p {
      margin-top: 6px;
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    /* --- Container --- */
    .container {
      width: 100%;
      max-width: 620px;
    }

    /* --- Input area --- */
    .input-row {
      display: flex;
      gap: 10px;
      margin-bottom: 24px;
    }
    .input-row input {
      flex: 1;
      padding: 14px 18px;
      background: var(--surface);
      border: 2px solid var(--border);
      border-radius: var(--radius);
      color: var(--text);
      font-size: 1rem;
      outline: none;
      transition: border-color var(--trans), box-shadow var(--trans);
    }
    .input-row input::placeholder { color: var(--text-muted); }
    .input-row input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(233,69,96,0.2);
    }
    .btn-add {
      padding: 14px 22px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: var(--radius);
      font-size: 1.4rem;
      font-weight: 700;
      cursor: pointer;
      transition: background var(--trans), transform var(--trans);
      line-height: 1;
    }
    .btn-add:hover { background: #c73652; transform: translateY(-1px); }
    .btn-add:active { transform: translateY(0); }

    /* --- Filter bar --- */
    .filter-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 10px;
    }
    .filter-tabs {
      display: flex;
      background: var(--surface);
      border-radius: 8px;
      padding: 4px;
      gap: 4px;
    }
    .filter-tabs button {
      padding: 6px 16px;
      background: transparent;
      border: none;
      border-radius: 6px;
      color: var(--text-muted);
      font-size: 0.85rem;
      cursor: pointer;
      transition: background var(--trans), color var(--trans);
    }
    .filter-tabs button.active {
      background: var(--accent);
      color: #fff;
    }
    .filter-tabs button:hover:not(.active) {
      color: var(--text);
      background: var(--border);
    }
    .stats {
      font-size: 0.82rem;
      color: var(--text-muted);
    }

    /* --- Todo list --- */
    .todo-list {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    /* --- Todo item --- */
    .todo-item {
      display: flex;
      align-items: center;
      gap: 14px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px 16px;
      animation: slideIn 0.2s ease;
      transition: box-shadow var(--trans), border-color var(--trans), opacity var(--trans);
      position: relative;
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-8px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .todo-item:hover {
      border-color: var(--accent2);
      box-shadow: var(--shadow);
    }
    .todo-item.done {
      opacity: 0.6;
    }

    /* custom checkbox */
    .check-wrap {
      flex-shrink: 0;
      width: 22px;
      height: 22px;
    }
    .check-wrap input[type="checkbox"] { display: none; }
    .check-wrap label {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 22px;
      height: 22px;
      border: 2px solid var(--text-muted);
      border-radius: 50%;
      cursor: pointer;
      transition: border-color var(--trans), background var(--trans);
    }
    .check-wrap input:checked + label {
      border-color: var(--check);
      background: var(--check);
    }
    .check-wrap label svg {
      opacity: 0;
      transition: opacity var(--trans);
    }
    .check-wrap input:checked + label svg { opacity: 1; }

    /* todo text */
    .todo-text {
      flex: 1;
      font-size: 0.97rem;
      line-height: 1.4;
      word-break: break-word;
      outline: none;
      cursor: default;
      border-radius: 4px;
      padding: 2px 4px;
      transition: background var(--trans);
    }
    .todo-text.editing {
      cursor: text;
      background: var(--card);
      box-shadow: 0 0 0 2px var(--accent2);
    }
    .todo-item.done .todo-text {
      text-decoration: line-through;
      color: var(--done-text);
    }

    /* priority badge */
    .priority {
      flex-shrink: 0;
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 20px;
      font-weight: 600;
      letter-spacing: 0.05em;
    }
    .priority.high   { background: rgba(233,69,96,0.2);  color: var(--accent); }
    .priority.medium { background: rgba(255,154,60,0.2); color: #ff9a3c; }
    .priority.low    { background: rgba(78,204,163,0.2); color: var(--check); }

    /* actions */
    .todo-actions {
      display: flex;
      gap: 6px;
      flex-shrink: 0;
      opacity: 0;
      transition: opacity var(--trans);
    }
    .todo-item:hover .todo-actions,
    .todo-item:focus-within .todo-actions { opacity: 1; }
    .icon-btn {
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--card);
      border: none;
      border-radius: 6px;
      color: var(--text-muted);
      cursor: pointer;
      transition: background var(--trans), color var(--trans);
    }
    .icon-btn:hover { background: var(--accent); color: #fff; }
    .icon-btn.edit-btn:hover { background: var(--accent2); }

    /* --- Priority selector --- */
    .priority-select {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 10px;
    }
    .priority-select label { font-size: 0.82rem; color: var(--text-muted); }
    .priority-select select {
      padding: 4px 8px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-size: 0.82rem;
      outline: none;
      cursor: pointer;
    }
    .priority-select select:focus { border-color: var(--accent); }

    /* --- Empty state --- */
    .empty {
      text-align: center;
      padding: 48px 16px;
      color: var(--text-muted);
    }
    .empty svg { margin-bottom: 12px; opacity: 0.4; }
    .empty p { font-size: 0.95rem; }

    /* --- Clear completed --- */
    .bottom-bar {
      display: flex;
      justify-content: flex-end;
      margin-top: 16px;
    }
    .btn-clear {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-muted);
      padding: 6px 14px;
      border-radius: 8px;
      font-size: 0.82rem;
      cursor: pointer;
      transition: border-color var(--trans), color var(--trans);
    }
    .btn-clear:hover { border-color: var(--accent); color: var(--accent); }

    /* --- Progress bar --- */
    .progress-wrap {
      margin-bottom: 20px;
    }
    .progress-label {
      display: flex;
      justify-content: space-between;
      font-size: 0.78rem;
      color: var(--text-muted);
      margin-bottom: 6px;
    }
    .progress-bar {
      height: 5px;
      background: var(--border);
      border-radius: 99px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), #ff9a3c);
      border-radius: 99px;
      transition: width 0.4s ease;
    }

    /* --- Scrollbar --- */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 99px; }
  </style>
</head>
<body>

<header>
  <h1>TODO</h1>
  <p>シンプルに、着実に。</p>
</header>

<div class="container">

  <!-- Input -->
  <div class="input-row">
    <input type="text" id="newTodo" placeholder="新しいタスクを入力... (Enter で追加)" autocomplete="off" />
    <button class="btn-add" id="addBtn" title="追加">+</button>
  </div>

  <!-- Priority -->
  <div class="priority-select">
    <label for="priorityPick">優先度:</label>
    <select id="priorityPick">
      <option value="none">なし</option>
      <option value="high">高</option>
      <option value="medium">中</option>
      <option value="low">低</option>
    </select>
  </div>

  <!-- Progress -->
  <div class="progress-wrap">
    <div class="progress-label">
      <span id="progressLabel">進捗</span>
      <span id="progressPct">0%</span>
    </div>
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill" style="width:0%"></div>
    </div>
  </div>

  <!-- Filter bar -->
  <div class="filter-bar">
    <div class="filter-tabs">
      <button class="active" data-filter="all">すべて</button>
      <button data-filter="active">未完了</button>
      <button data-filter="done">完了</button>
    </div>
    <span class="stats" id="stats"></span>
  </div>

  <!-- List -->
  <ul class="todo-list" id="todoList"></ul>

  <!-- Empty state (hidden when items exist) -->
  <div class="empty" id="emptyState" style="display:none">
    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
      <path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2"/>
      <rect x="9" y="3" width="6" height="4" rx="1"/>
      <path d="M9 12h6M9 16h4"/>
    </svg>
    <p>タスクはありません</p>
  </div>

  <!-- Bottom -->
  <div class="bottom-bar">
    <button class="btn-clear" id="clearDone">完了済みを削除</button>
  </div>
</div>

<script>
  // ── State ──────────────────────────────────────────────
  let todos = JSON.parse(localStorage.getItem('todos-v2') || '[]');
  let filter = 'all';
  let editingId = null;

  // ── Persistence ────────────────────────────────────────
  function save() {
    localStorage.setItem('todos-v2', JSON.stringify(todos));
  }

  // ── ID generator ───────────────────────────────────────
  function uid() {
    return Date.now().toString(36) + Math.random().toString(36).slice(2);
  }

  // ── Render ─────────────────────────────────────────────
  function render() {
    const list = document.getElementById('todoList');
    const empty = document.getElementById('emptyState');
    const statsEl = document.getElementById('stats');
    const progressFill = document.getElementById('progressFill');
    const progressPct = document.getElementById('progressPct');
    const progressLabel = document.getElementById('progressLabel');

    // filter
    const visible = todos.filter(t => {
      if (filter === 'active') return !t.done;
      if (filter === 'done')   return t.done;
      return true;
    });

    // progress
    const total = todos.length;
    const doneCount = todos.filter(t => t.done).length;
    const pct = total ? Math.round(doneCount / total * 100) : 0;
    progressFill.style.width = pct + '%';
    progressPct.textContent = pct + '%';
    progressLabel.textContent = `${doneCount} / ${total} 完了`;

    // stats
    const activeCount = todos.filter(t => !t.done).length;
    statsEl.textContent = `${activeCount} 件残り`;

    // empty
    empty.style.display = visible.length === 0 ? 'block' : 'none';

    // items
    list.innerHTML = '';
    visible.forEach(todo => {
      const li = document.createElement('li');
      li.className = 'todo-item' + (todo.done ? ' done' : '');
      li.dataset.id = todo.id;

      // checkbox
      const checkWrap = document.createElement('div');
      checkWrap.className = 'check-wrap';
      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.id = 'cb-' + todo.id;
      cb.checked = todo.done;
      cb.addEventListener('change', () => toggle(todo.id));
      const lbl = document.createElement('label');
      lbl.htmlFor = 'cb-' + todo.id;
      lbl.innerHTML = `<svg width="12" height="12" viewBox="0 0 12 12" fill="none">
        <polyline points="2,6 5,9 10,3" stroke="#1a1a2e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>`;
      checkWrap.append(cb, lbl);

      // text
      const span = document.createElement('span');
      span.className = 'todo-text' + (editingId === todo.id ? ' editing' : '');
      span.textContent = todo.text;
      span.contentEditable = editingId === todo.id ? 'true' : 'false';
      span.addEventListener('dblclick', () => startEdit(todo.id, span));
      span.addEventListener('keydown', e => {
        if (e.key === 'Enter') { e.preventDefault(); commitEdit(todo.id, span); }
        if (e.key === 'Escape') { cancelEdit(span, todo.text); }
      });
      span.addEventListener('blur', () => {
        if (editingId === todo.id) commitEdit(todo.id, span);
      });

      // priority badge
      const badge = todo.priority && todo.priority !== 'none'
        ? Object.assign(document.createElement('span'), {
            className: `priority ${todo.priority}`,
            textContent: { high: '高', medium: '中', low: '低' }[todo.priority]
          })
        : null;

      // actions
      const actions = document.createElement('div');
      actions.className = 'todo-actions';

      const editBtn = document.createElement('button');
      editBtn.className = 'icon-btn edit-btn';
      editBtn.title = '編集';
      editBtn.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
      </svg>`;
      editBtn.addEventListener('click', () => startEdit(todo.id, span));

      const delBtn = document.createElement('button');
      delBtn.className = 'icon-btn';
      delBtn.title = '削除';
      delBtn.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="3 6 5 6 21 6"/>
        <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/>
        <path d="M10 11v6M14 11v6"/>
        <path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/>
      </svg>`;
      delBtn.addEventListener('click', () => remove(todo.id));

      actions.append(editBtn, delBtn);

      li.append(checkWrap, span);
      if (badge) li.append(badge);
      li.append(actions);
      list.append(li);

      // focus if editing
      if (editingId === todo.id) {
        setTimeout(() => {
          span.focus();
          const range = document.createRange();
          range.selectNodeContents(span);
          range.collapse(false);
          const sel = window.getSelection();
          sel.removeAllRanges();
          sel.addRange(range);
        }, 0);
      }
    });
  }

  // ── Actions ────────────────────────────────────────────
  function addTodo() {
    const input = document.getElementById('newTodo');
    const priority = document.getElementById('priorityPick').value;
    const text = input.value.trim();
    if (!text) return;
    todos.unshift({ id: uid(), text, done: false, priority, createdAt: Date.now() });
    save();
    input.value = '';
    input.focus();
    render();
  }

  function toggle(id) {
    const t = todos.find(t => t.id === id);
    if (t) { t.done = !t.done; save(); render(); }
  }

  function remove(id) {
    todos = todos.filter(t => t.id !== id);
    save();
    render();
  }

  function startEdit(id, span) {
    editingId = id;
    render();
  }

  function commitEdit(id, span) {
    const t = todos.find(t => t.id === id);
    const newText = span.textContent.trim();
    if (t && newText) { t.text = newText; }
    editingId = null;
    save();
    render();
  }

  function cancelEdit(span, original) {
    span.textContent = original;
    editingId = null;
    render();
  }

  // ── Filter ─────────────────────────────────────────────
  document.querySelectorAll('.filter-tabs button').forEach(btn => {
    btn.addEventListener('click', () => {
      filter = btn.dataset.filter;
      document.querySelectorAll('.filter-tabs button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      render();
    });
  });

  // ── Clear completed ────────────────────────────────────
  document.getElementById('clearDone').addEventListener('click', () => {
    if (todos.some(t => t.done)) {
      todos = todos.filter(t => !t.done);
      save();
      render();
    }
  });

  // ── Add button / Enter ─────────────────────────────────
  document.getElementById('addBtn').addEventListener('click', addTodo);
  document.getElementById('newTodo').addEventListener('keydown', e => {
    if (e.key === 'Enter') addTodo();
  });

  // ── Init ───────────────────────────────────────────────
  render();
</script>
</body>
</html>
